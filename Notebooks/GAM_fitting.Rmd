---
title: "GAM fitting"
date: "07-09-2020"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r setup}
library (mgcv)
library (tidyverse)

# predictor dataframe
mfri_pred <- read_csv ("../Data/MFRI_predictor_df.csv",
                       col_types = cols(
                      sample_id = col_factor(),

                      stat_sq = col_factor()
                      )
                      ) %>%
  filter (!(year == 2011 & season == "autumn"))  # remove autumn 2011, 131 samples

# presence absence data
mfri_pa <- read_csv ("../Data/PA_MFRI.csv",
                     col_types = cols(
                       sample_id = col_factor()
                     ))

# abundance data
mfri_abun <- read_csv ("../Data/MFRI_comb_survey.csv",
                      col_types = cols(
                      sample_id = col_factor(),
                      species = col_factor(),
                      stat_sq = col_factor()
                      )
                      )%>%
  filter (!(year == 2011 & season == "autumn")) %>% # remove autumn 2011
  group_by (sample_id, species) %>%
  summarize (n_tot = sum(n_per_nautmile),
             kg_tot = sum(kg_per_nautmile)) %>%
  mutate (n_log = log(n_tot),
          kg_log = log(kg_tot))


# https://people.maths.bris.ac.uk/~sw15190/mgcv/tampere/mgcv.pdf

# species list
spp <- read_csv ("../Data/species_eng.csv",
                 col_types = cols(
                       Spp_ID = col_factor()
                     ))

spp_25 <- spp %>%
  filter (n_autumn > 24 & n_spring > 35)

```
### Fit for all species
```{r}

# build folders to hold models
dir.create ("../Models")
dir.create("../Models/PresAbs")
dir.create("../Models/Biomass")

# build data frame to hold gam results
maj_spp_gam_summary <- data.frame ()

for (spp in spp_25$Spp_ID) {
  
  # match species ID to scientific name
  sci_name <- spp_25$sci_name_underscore[which (spp_25$Spp_ID == spp)]
  
  #grab presence/absence data and attach to predictor frame
  spp_PA <- mfri_pa %>%
    dplyr::select (sample_id, sci_name) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # don't know how to do this elegantly within a pipe, but change colname to presence
  colnames(spp_PA)[2] <- "Presence"
  
  
  # biomass data; this will have variable size
  spp_B <- mfri_abun %>%
    filter (species == spp) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # fit gams
  gam_PA <- gam (Presence ~ te(lon, lat) + year + season + s(surface_temp) + s(bottom_temp) + s(gins_sal) +s(tow_depth_begin),
                 family = "binomial", 
                 data = spp_PA)
  
  gam_LB <- gam (kg_log ~ te(lon, lat) + year + season + s(surface_temp) + s(bottom_temp) + s(gins_sal) +s(tow_depth_begin),
                 family = "gaussian", 
                 data = spp_B)
  
  
  # populate table
  summary <- cbind (sci_name, 
                    summary (gam_PA)[14], # dev expl
                    summary (gam_PA)[10], # r2
                    summary (gam_PA)[26], # ubre? GCV?
                    AIC(gam_PA),
                    summary (gam_LB)[14],
                    summary (gam_LB)[10],
                    summary (gam_LB)[26],
                    AIC(gam_LB),
                    summary (gam_LB)[13] #n
                    )
  
  
  maj_spp_gam_summary <- rbind (maj_spp_gam_summary, summary)
  
  save (gam_PA, file = paste0("../Models/PresAbs/", sci_name, "_PA_full.Rdata"))
  save (gam_LB, file = paste0("../Models/Biomass/", sci_name, "_LB_full.Rdata"))
    
}

colnames (maj_spp_gam_summary) <- c("Species",
                                    "PA_dev_exp", "PA_adj_r2", "PA_UBRE","PA_AIC",
                                    "LB_dev_exp", "LB_adj_r2", "LB_UBRE", "LB_AIC","LB_n" )

save (maj_spp_gam_summary, file = "../Models/Major_spp_summary_table.RData")
```

### Cod
```{r cod_data}
#subset cod presence and absence
cod_pa <- mfri_pa %>%
  dplyr::select (sample_id, Gadus_morhua) %>%
  rename (Presence = Gadus_morhua)

# append to sample info
cod_pred <- cod_pa %>%
  right_join (mfri_pred, by = "sample_id")

# start with lat, lon, year, season, mfri temp, and salinity
```

```{r cod_full}

cod_full <- gam (Presence ~ te(lon, lat) + year + season + s(surface_temp) + s(bottom_temp) + s(gins_sal) +s(tow_depth_begin),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_full)

par (mfrow = c (2, 3), mar = c (2, 1.5, 1.5, 1.5), oma = c(0,1,2,0))
plot (cod_full, residuals = TRUE, 
      select = 1, 
      ylab = "", xlab = "", 
      main = paste ("te(Lon, Lat)", round (summary (cod_full)$edf[1], 2), sep = ", "))
plot (cod_full, residuals = TRUE, 
      select = 2, 
      #ylim = c (-5, 5), 
      ylab = "", xlab = "", 
      main = paste ("s(sst)", round (summary (cod_full)$edf[2], 2), sep = ", "))
plot (cod_full, residuals = TRUE, 
      select = 3, 
      #ylim = c (-10, 10), 
      ylab = "", xlab = "", 
      main = paste ("s(bt)", round (summary (cod_full)$edf[3], 2), sep = ", "))
plot (cod_full, residuals = TRUE, 
      select = 4, 
      #ylim = c (-10, 15), 
      ylab = "", xlab = "", 
      main = paste ("s(sal)", round (summary (cod_full)$edf[4], 2), sep = ", "))


```
One extreme low residual. not sure how to find it
```{r}
resid <- residuals.gam(cod_full)
hist (resid)
```
```{r drop_var_table}
full.terms <- c ("te (lon, lat)", "year", "season", "s(surface_temp)", "s(bottom_temp)", "s(gins_sal)")

single.var.comp <- data.frame()
for (x in full.terms){
  # single variable model
  formula <- as.formula (paste0 ("Presence ~", x))
  G <- gam (formula, family = binomial, data = cod_pred)
  
  # full model without that variable
 formula_drop <- as.formula (paste0 ("Presence ~", (paste (full.terms[! full.terms %in% x], collapse = " + "))))
 G_drop <- gam (formula_drop, family = binomial, data = filter (cod_pred, !is.na (x)))
 

  # extract summaries, put together in temporary df
  df <- data.frame (Var = x, 
                    R2_full = round (summary (cod_full)$dev.expl * 100, 2),
                
                    R2_s = round (summary(G)$dev.expl * 100, digits = 2),
                   
                    R2_d =  round (summary(G_drop)$dev.expl * 100, digits = 2),
                    #N_full = length (G_full$y),
                    
                    Diff_full = round (summary(G_drop)$dev.expl * 100 - summary (cod_full)$dev.expl * 100, 2)
  )
  
  # rbind to full data frame
  single.var.comp <- rbind (single.var.comp, df)
  
}

dir.create ("../Models/PresAbs_summary_tables")
save (single.var.comp, file = "../Data/PA_model_tables/Cod_single_var_comp.RData")
```
Lat/lon has biggest signal -- 13%, driving 50% of the signal. . season is the next, 4. Salinity makes worse. 
```{r}
# lat/lon interaction
cod_full_2 <- gam (Presence ~ lon*lat + year + season + s(surface_temp) + s(bottom_temp) + s(gins_sal),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_full_2)
```
```{r}
# satellite instead of in situ
cod_full_sat <- gam (Presence ~ te(lon, lat) + year + season + s(oisst) + s(gins_bt) + s(gins_sal) +s(tow_depth_begin),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_full_sat)

```

