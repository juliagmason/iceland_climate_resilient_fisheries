---
title: "GAM fitting"
date: "07-09-2020"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r setup}
library (mgcv)
library (tidyverse)

# package for formatting tables
library (kableExtra)
# prevent text from running off PDF:
library (knitr)
opts_chunk$set(tidy.opts=list(width.cutoff = 60), tidy = TRUE)

# predictor dataframe with environmental variables
mfri_pred <- read_csv ("../Data/MFRI_predictor_df.csv",
                       col_types = cols(
                      sample_id = col_factor(),

                      stat_sq = col_factor(),
                      bormicon_region = col_factor(),
                      sst_dev = col_number(),
                      bt_dev = col_number(),
                      sst_max = col_number(),
                      sst_min = col_number(),
                      bt_max = col_number(),
                      bt_min = col_number()
                      )
                      ) %>%
  filter (!(year == 2011 & season == "autumn"),
          !(year < 2000 & season == "autumn"))  # remove autumn 2011, 131 samples. Also cutting out autumn pre-2000 (as of 7/23/2020. so did this with MASE fitting, but not with original run through of full gams)

# presence absence data. this would still have 2011 and pre-2000 autumn samples
mfri_pa <- read_csv ("../Data/PA_MFRI.csv",
                     col_types = cols(
                       sample_id = col_factor()
                     ))

# abundance data
mfri_abun <- read_csv ("../Data/MFRI_comb_survey.csv",
                      col_types = cols(
                      sample_id = col_factor(),
                      species = col_factor(),
                      stat_sq = col_factor()
                      )
                      )%>%
  filter (!(year == 2011 & season == "autumn"),
          !(year < 2000 & season == "autumn")) %>% # remove autumn 2011
  group_by (sample_id, species) %>%
  summarize (n_tot = sum(n_per_nautmile),
             kg_tot = sum(kg_per_nautmile)) %>%
  mutate (n_log = log(n_tot),
          kg_log = log(kg_tot))


# https://people.maths.bris.ac.uk/~sw15190/mgcv/tampere/mgcv.pdf

# species list
spp_list <- read_csv ("../Data/species_eng.csv",
                 col_types = cols(
                       Spp_ID = col_factor()
                     ))

# "major" species, defined as those caught in all 25 years of autumm survey and 36 of spring
spp_25 <- spp_list %>%
  filter (n_autumn > 24 & n_spring > 35)

# species that worked for gams
spp_totals <- mfri_abun %>% 
  group_by (species) %>% 
  summarize (count = n()) %>% 
  filter (count > 50) %>%  # need to have enough observations for the model: https://stackoverflow.com/questions/36719799/mgcv-gam-error-model-has-more-coefficients-than-data
  filter (!species %in% c(41, 72, 97, 35, 92, 49, 89))

# save this species list
# spp_Smooth_latlon <- spp_totals %>%
#   rename (Spp_ID = species) %>%
#   left_join (spp_list, by = 'Spp_ID') %>%
#   select (Spp_ID, sci_name_underscore)
# 
#save (spp_Smooth_latlon, file = "../Models/spp_Smooth_latlon.RData")

```

# First model -- Tensor season
### Fit individual full GAM for all species
Note: these were fit with pre-2000 fall data, but 2011 excluded. 

Re ran a few times, dropped season, then did with s(lat, lon) instead of te(lat, lon). On 9/14 I switched around the file structure so I have a folder for each model instead of separate PA/biomass folders. 
```{r fit_full_gam}

# build folders to hold models
# dir.create ("../Models")
# dir.create("../Models/PresAbs")
# dir.create("../Models/Biomass")
# 
# 
# # do this again without season (or salinity)
# dir.create("../Models/PresAbs/Tensor_drop_season")
# dir.create("../Models/Biomass/Tensor_drop_season")
# 
# # again, with gamma, with smoothed lat/lon s(lat,lon) 8/10/2020
# dir.create ("../Models/PresAbs/Smooth_latlon")
# dir.create ("../Models/Biomass/Smooth_latlon")

# build data frame to hold gam results
maj_spp_gam_summary <- data.frame ()

# 9/8/2020 do again for additional species not in top 25
addl_spp <- as.character(spp_totals$species[which (! spp_totals$species %in% spp_25$Spp_ID)])  # use as.character to avoid error with differing factor levels

#for (spp in spp_25$Spp_ID) {
  for (spp in addl_spp) {
  
  
  # match species ID to scientific name
  sci_name <- spp_list$sci_name_underscore[which (spp_list$Spp_ID == spp)]
  
  #grab presence/absence data for that species and attach to predictor data
  spp_PA <- mfri_pa %>%
    dplyr::select (sample_id, all_of(sci_name)) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # don't know how to do this elegantly within a pipe, but change colname to presence
  colnames(spp_PA)[2] <- "Presence"
  
  
  # non-zero biomass data; this will have variable size. 
  spp_B <- mfri_abun %>%
    filter (species == spp) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # set gamma
  set.seed (10)
  gamma_PA <- log (nrow (spp_PA)) / 2
  gamma_B <- log (nrow (spp_B)) / 2
  
  # fit gams
  gam_PA <- gam (Presence ~ s(lat, lon) + year + s(surface_temp) + s(bottom_temp) +s(tow_depth_begin),
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)
  
  gam_LB <- gam (kg_log ~ s(lat, lon) + year + s(surface_temp) + s(bottom_temp) +s(tow_depth_begin),
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
  
  # populate table
  summary <- cbind (sci_name, 
                    round(summary (gam_PA)$dev.expl, 2), # dev expl
                    round(summary (gam_PA)$r.sq, 2), # r2
                    round(summary (gam_PA)$sp.criterion, 2), # ubre? GCV?
                    round(AIC(gam_PA), 2),
                    round(summary (gam_LB)$dev.expl, 2),
                    round(summary (gam_LB)$r.sq, 2),
                    round(summary (gam_LB)$sp.criterion, 2),
                    round(AIC(gam_LB), 2),
                    summary (gam_LB)[13] #n
                    )
  
  
  maj_spp_gam_summary <- rbind (maj_spp_gam_summary, summary)
  
  save (gam_PA, file = paste0("../Models/PresAbs/Smooth_latlon/", sci_name, "_PA_full.Rdata"))
  save (gam_LB, file = paste0("../Models/Biomass/Smooth_latlon/", sci_name, "_LB_full.Rdata"))
    
}

colnames (maj_spp_gam_summary) <- c("Species",
                                    "PA_dev_exp", "PA_adj_r2", "PA_UBRE","PA_AIC",
                                    "LB_dev_exp", "LB_adj_r2", "LB_UBRE", "LB_AIC","LB_n" )

#https://stackoverflow.com/questions/24829027/unimplemented-type-list-when-trying-to-write-table
# weird error about list 
maj_spp_gam_summary <- apply(maj_spp_gam_summary,2,as.character)
write.csv (maj_spp_gam_summary, file = "../Models/Major_spp_summary_table_slatlon.csv", row.names = FALSE)
write.csv (MASE_all_spp, file = "../Models/MASE_table_all_spp.csv", row.names = FALSE)
```

### Display model table
```{r gam_table}
load ("../Models/Major_spp_summary_table.RData")

sum_round <- maj_spp_gam_summary %>%
  mutate_if(is.numeric, round, 2) # doesn't seem to work

kable (sum_round, caption = "GAM outputs", align = "l", row.names = FALSE, digits = 2) %>% # digits also doesn't seem to work
  row_spec(0, bold = T) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

### Compare GAM vs random walk for biomass model

I'm going to divide into testing and training data. KK did approximately 80/20 with most recent data as training set. It looks from KK code that she's using one dataset for both PA and biomass, so giving the biomass GAM all the zeroes. does bring the dev expl down. with haddock, was 38%, now 23. Decided after call on 7/22 that it really should be presence-only data for the biomass model, that's the point of separating PA vs. biomass. 

Still figuring out how to deal with zero biomass in the test set, however. 

I'm also dropping salinity here. Doesn't seem to be contributing enough for enough species, and since it's a climatology through 2012 I lose a lot of data, plus my whole testing set. 
```{r rwf_test}
library (forecast)

quantile (mfri_pred$year, 0.8) # 2013 os 75%, 2014 is 80%. If IU include 2013 in training, it's 77%, if I don't, it's 73.6%. Other papers used 80/20, so will include

# try with all species. arrange by most to least common. need to have more observations than model coefficients (6), starting with 10
spp_totals <- mfri_abun %>% 
  group_by (species) %>% 
  summarize (count = n()) %>% 
  filter (count > 50) %>% # need to have enough observations for the model
  filter (!species %in% c(72, 97, 89, 35, 92, 10, 49)) # just manually removing the ones that give errors. e.g. 72 only has spring post 2013 so model gets mad. 

#calculate_MASE_fun <- function (spp) {

## build dataframe, do for loop instead of function
MASE_all_spp <- data.frame()

for (spp in spp_totals$species) {
  

# link species code to scientific name in PA dataset
sci_name <- spp_list$sci_name_underscore[which (spp_list$Spp_ID == spp)]

# signal where we are in the process
print(paste(sci_name, Sys.time()))

#Presence/absence data for species
PA_spp <- mfri_pa %>%
  # https://tidyselect.r-lib.org/reference/faq-external-vector.html need to use all_of for externally named variable
  dplyr::select (sample_id, all_of(sci_name)) 
colnames (PA_spp)[2] <- "Presence"

# biomass data--need presence-only training set and presence/absence testing set
LB_spp <- mfri_abun %>%
  filter (species == spp)

full_data_spp <- PA_spp %>%
  left_join (LB_spp, by = "sample_id") %>% # add abundance data
  replace_na (list(n_tot = 0, kg_tot = 0, n_log = 0, kg_log = 0)) %>% # replace all NAs (absences) with zero. what about biomass of 1? none have
  right_join (mfri_pred, by = "sample_id") # add predictor variables and cut out faulty autumn samples. should have 27524 
  
# divide into testing and training
train_spp <-  full_data_spp %>% 
    filter (year <= 2013)

# presence-only data for training
train_spp_B <- train_spp %>%
  filter (n_tot > 0)

test_spp <-  full_data_spp %>%
  filter (year > 2013)

## Random walk forecast

Naive_forecast_lambda <-rwf(train_spp$kg_tot, drift=T, h= nrow (test_spp), lambda = -0.5, biasadj=T) 
# with drift = F, this is just the last value observed, repeated h times. with drift = T, random walk based on the last value, but seems totally dependent on the last value. 

# try with and without biasadj = T
Naive_forecast <- rwf (train_spp$kg_tot, drift = T, h = nrow (test_spp), lambda = NULL, biasadj = F) 

# don't see any difference with biasadj = T, with either log or total biomass. when I have both biasadj and lambda = -0.5, it does make a difference. much larger drift with biasadj = T

## Naive GAM (no environmental variables)
gam_LB_naive <- gam (kg_log ~ te(lon, lat) + year + season + s(tow_depth_begin),
                 family = "gaussian", 
                 data = train_spp_B)

gam_PA_naive <- gam (Presence ~ te(lon, lat) + year + season + s(tow_depth_begin),
                 family = "binomial", 
                 data = train_spp)

gampred_LB_naive <- predict.gam (gam_LB_naive, test_spp, type = "response")
gampred_PA_naive <- predict.gam (gam_PA_naive, test_spp, type = "response")

Eresid_naive <- mean (exp (residuals.gam (gam_LB_naive)))

ThermPred_spp_naive <- gampred_PA_naive * (exp (gampred_LB_naive)) * Eresid_naive

## Full GAM 

gam_LB <- gam (kg_log ~ te(lon, lat) + year + season + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin),
                 family = "gaussian", 
                 data = train_spp_B)

gam_PA <- gam (Presence ~ te(lon, lat) + year + season + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin),
                 family = "binomial", 
                 data = train_spp)

gampred_LB <- predict.gam (gam_LB, test_spp, type = "response")
gampred_PA <- predict.gam (gam_PA, test_spp, type = "response")

# KK took inverse log of LB residuals, and then one mean value for each species
Eresid <- mean (exp (residuals.gam (gam_LB)))

# ThermPred is PA prediction * log (LB prediction) * log (LB residual). MAE is absolute value of thermPred - observed biomass.
ThermPred_spp <- gampred_PA * (exp (gampred_LB)) * Eresid


## Calculate MAE
MAE_gam <- abs(ThermPred_spp - test_spp$kg_tot) 

MAE_gam_naive <- abs (ThermPred_spp_naive - test_spp$kg_tot)

MAE_rwf <- abs (Naive_forecast$mean - test_spp$kg_tot)

MAE_rwf_lambda <- abs (Naive_forecast_lambda$mean^-0.5 - test_spp$kg_tot) # should it be transformed? abs (Naive_forecast_lambda$mean^-0.5 - test_spp$kg_tot)

## Build df

MASE_spp <- data.frame (
  Species = sci_name, 
  RWF = mean (MAE_gam, na.rm = TRUE) / mean (MAE_rwf, na.rm = TRUE), # why mean instead of median? 
  RWF_lambda = mean (MAE_gam, na.rm = TRUE) / mean (MAE_rwf_lambda, na.rm = TRUE),
  Naive_GAM = mean (MAE_gam, na.rm = TRUE) / mean (MAE_gam_naive, na.rm = TRUE)
)
 

MASE_all_spp <- rbind (MASE_all_spp, MASE_spp)

}

write.csv (MASE_all_spp, file = "../Models/MASE_table_all_spp.csv", row.names = FALSE)

# calculate_MASE_fun(2)
# 
# spp_25_MASE <- lapply (as.vector(spp_25$Spp_ID), calculate_MASE_fun)
# names (spp_25_MASE) <- spp_25$Scientific_name
```
With bias = T and lambda = -0.5, GAM is way better for all species. mean is 0.01, median is 1.12e05, max is 0.15 (silver smelt)
Without biasadj = T, 7 are > 1.mean is 0.68, median 0.72, max 3.17. Per email from Charles Perretti on 7/22/2020, he suggested using neither lambda nor biasadj. 

"That sounds like an interesting project. It's been a while but if I remember correctly we used the random walk model as a sort of null model to compare against the GAM. I don't remember using the Box-Cox transformation, but it's basically just a way to make the data look closer to a normal distribution. In general I would vote against using it because the choice of the lambda parameter is somewhat arbitrary, and it's just a bit more difficult to explain. If you did use it though you would want to use the bias-correction to return unbiased estimates of the mean prediction. So basically I would turn it off by setting lambda = NULL, and biasadj = FALSE. But if you do use it I would set biasadj = TRUE."

For MASE table, full gam outperforms naive gam for all species for which the model worked (65) except mackerel. Did way better than rwf with lambda and biasadj. But for regular rwf, did worse in the majority of cases. Some are kind of crazy--Eutrigla_gurnardus (99) ratio is in the hundred millions, PAndalus is infinite, L. reticulatus is 6500. 

S. acanthius (dogfish) has only 251 presences in training set. It's caught most years, but looks like in the single digits of sets. 

E. gurnardus has 1386 presences. 891 in training set. It's something about very small and very large numbers. The normal rwf predictions are all very tiny numbers, median e=16. Whereas the gams are predicting some quite large numbers, log biomass up around 28. Last value of biomass training is 1.48, but last value of whole training set is 0. 
Lumpfish had good scores for everything. It has 9325 presences, 7534 in training set. 


Is the performance of rwf vs. gam dependent on having presence or absence as the last value in the training set? also seeing very few non-NA values for rwf-Lambda. only 90 /6300 for monkfish for example. 

Scomber scombrus atl mackerel, env gam performed worse than naive gam. Only 350 presences, and 211 in test set. 


Setting test set kg_log to 0 vs. -18 or something like that doesn't make a difference, because the test set kg_log actual values don't come into play for error measurement. using just kg_tot and exp(prediction). 


### DISMO model evaluations
Morely et al takes preds1 (fitted.values/gampred for PA). makes vector of presences and absences. evaluate acts on a column of predicted values at observed presences and ovserved absences

for kappa and TSS, for the full model he doesn't use a threshold. modeldiag$tssmax is max tss for full model. tssmax.tt is max from test. tss is with e.ind, prevalence threshold from full model. tss.tt is with e.ind.tt, which is the minimum difference between test evaluation and training prevalence threshold. 

takes the threshold from training data that best matches testing data--minimum absolute difference between model diag.thres.tr [prevalence] and e.tt@t
```{r dismo_PA}


library(dismo)
p <- as.vector(gampred_PA[which (test_spp$Presence == 1)])
a <- as.vector(gampred_PA[which (test_spp$Presence == 0)])

e <- evaluate (p, a)
plot (e, "ROC") # want closer to 1
e@auc

threshold(e, stat = "kappa") # 0.89
prev_th <- threshold (e, stat = "prevalence")
e.ind <- which (e@t == prev_th)

conf <- as.data.frame (e@confusion) # 4 columns, tp, fp, fn, tn

sens <- with (conf, tp/(tp + fn))

tss_max <- max (with (conf, (tp/(tp + fn) + (tn)/(tn+fp) - 1)))
tss_th <- with (conf[e.ind,], (tp/(tp + fn) + (tn)/(tn+fp) - 1))

kap_max <- max (e@kappa)
kap_th <- e@kappa[e.ind]

# find min th from training data

# fitted values from training data
p.train <- gam_PA$fitted.values[which(train_spp$Presence == 1)]
a.train <- gam_PA$fitted.values[which(train_spp$Presence == 0)]

e.train <- evaluate(p.train, a.train)

prev.th.train <- threshold (e.train, stat = "prevalence")

diff <- abs (e@t - prev.th.train)
e.ind.train <- which (diff == min(diff))


kap_tr <- e@kappa[e.ind.train]
tss_tr <- with (conf[e.ind.train,], (tp/(tp + fn) + (tn)/(tn+fp) - 1))
```

for biomass, he looked at dev explained but als opredicted vs observed biomass when present==correlation cor^2
```{r morely_Biomass_Cor}

cor_B <- cor (gampred_LB[which (test_spp$Presence ==1 & !is.na(gampred_LB))], test_spp$kg_log[which (test_spp$Presence == 1 & !is.na(gampred_LB))])^2

```

Kristin also did the diebold mariano test in forecast library. E1 is naive gam thermpred minus maive gam observed biomass. E2 is gampreds full thermpred minus biomass. 
```{r dm_test}

# doesn't accept nas. also looks like shouldn't be absolute

E1 <- ThermPred_spp_naive - test_spp$kg_tot
E2 <- ThermPred_spp - test_spp$kg_tot

E1_cc <- E1 [ which (!is.na(E1) & !is.na(E2))]
E2_cc <- E2 [ which (!is.na(E1) & !is.na(E2))]

dm_gam <- dm.test (E1_cc, E2_cc, h = 1, power = 1, alternative = "greater")
dm_gam

```
### interpret results from gam diagnostics 7/35
```{r gam_diag}

gam_diag <- read_csv ("../Models/GAM_diagnostics_all_spp.csv")

suitable_spp <- gam_diag %>%
  filter (MASE_GAM < 1 & DM_GAM_p < 0.05)

```
28 species, doesn't include cod?? really very few species out perform random walk. 

# More habitat variables 
### Incorporate Bormicon and temp max, min, stdev, no lat/lon

Some of these are correlated, so I'm going to run the full model and also record the single dex expl and difference in dropping each variable, maybe can take a mean or something. just doing for PA
```{r temp_hab}

dir.create ("../Models/Bormicon_allTemp")
dir.create ("../Models/Depth_Temp")


# need > 92 observations
spp_borm <- mfri_abun %>% 
  group_by (species) %>% 
  summarize (count = n()) %>% 
  filter (count > 70) %>%  # 92 for borm # need to have enough observations for the model: https://stackoverflow.com/questions/36719799/mgcv-gam-error-model-has-more-coefficients-than-data
  filter (!species %in% c(21))
# hippoglossus did not converge for borm 

# build data frame to hold gam results
gam_stats <- data.frame ()

for (spp in spp_25$Spp_ID) {

  
  # match species ID to scientific name
  sci_name <- spp_list$sci_name_underscore[which (spp_list$Spp_ID == spp)]
  
  #grab presence/absence data for that species and attach to predictor data
  spp_PA <- mfri_pa %>%
    dplyr::select (sample_id, all_of(sci_name)) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # don't know how to do this elegantly within a pipe, but change colname to presence
  colnames(spp_PA)[2] <- "Presence"
  
  
  # non-zero biomass data; this will have variable size. 
  spp_B <- mfri_abun %>%
    filter (species == spp) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # set gamma
  set.seed (10)
  gamma_PA <- log (nrow (spp_PA)) / 2
  gamma_B <- log (nrow (spp_B)) / 2
  
  # fit gams
  # gam_PA <- gam (Presence ~ bormicon_region + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) + s(sst_dev) + s(bt_dev) + s(sst_max) + s(sst_min) + s(bt_max) + s(bt_min),
  #                family = "binomial", 
  #                data = spp_PA,
  #                gamma = gamma_PA)
  # 
  # gam_LB <- gam (kg_log ~ bormicon_region + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) + s(sst_dev) + s(bt_dev) + s(sst_max) + s(sst_min) + s(bt_max) + s(bt_min),
  #                family = "gaussian", 
  #                data = spp_B,
  #                gamma = gamma_B)
  
  
    gam_PA <- gam (Presence ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max) ,
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)
  
  gam_LB <- gam (kg_log ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max) ,
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
  # record summary stats
  gam_summary <- data.frame(
    Species = sci_name,
    PA_dev_exp = round(summary (gam_PA)$dev.expl, 2), 
    PA_AIC = round(AIC(gam_PA), 2),
    LB_dev_exp =  round(summary (gam_LB)$dev.expl, 2),
    LB_AIC = round(AIC(gam_LB), 2)
  )
    
  
  # drop variables
  
  # full_terms <- c ("bormicon_region", "year", "s(surface_temp)", "s(bottom_temp)", "s(tow_depth_begin)", "s(sst_dev)", "s(bt_dev)", "s(sst_max)", "s(sst_min)", "s(bt_max)", "s(bt_min)")
  
  full_terms <- c ("s(surface_temp)", "s(bottom_temp)", "s(tow_depth_begin)", "s(sst_max)", "s(sst_min)", "s(bt_max)")

  var_comp_df <- data.frame()
  
  for (x in full_terms){
    # single variable model
    formula <- as.formula (paste0 ("Presence ~", x))
    G <- gam (formula, family = binomial, data = spp_PA)
    
    # full model without that variable
   formula_drop <- as.formula (paste0 ("Presence ~", (paste (full_terms[! full_terms %in% x], collapse = " + "))))
   G_drop <- gam (formula_drop, family = binomial, data = filter (spp_PA, !is.na (x)))
   
  
    # extract summaries, put together in temporary df
    drop_df <- data.frame (Var = x, 
                      R2_s = round (summary(G)$dev.expl * 100, digits = 2),
   
                      Diff_full = round (summary(G_drop)$dev.expl * 100 - summary (gam_PA)$dev.expl * 100, 2)
    )
    
    # rbind to full data frame
    var_comp_df <- rbind (var_comp_df, drop_df)
    
  }
  
  # pivot var_comp wider
  var_wide <- var_comp_df %>%
    pivot_wider (names_from = Var, values_from = c(R2_s, Diff_full))
    
  # add to gam stats
  gam_df <- cbind (gam_summary, var_wide)
  
  # rbind
  gam_stats <- rbind (gam_stats, gam_df)
  
  
  save (gam_PA, file = paste0("../Models/Depth_Temp/", sci_name, "_PA.Rdata"))
  save (gam_LB, file = paste0("../Models/Depth_Temp/", sci_name, "_LB.Rdata"))
    
}

 write.csv (borm_gam_summary, file = "../Models/borm_gam_table_tmp.csv", row.names = FALSE)
 write.csv (gam_stats, file = "../Models/depth_temp_gam_table_25.csv", row.names = FALSE)

```

### AIC test for correlated vars
do on sample of 1000 rows to move a bit faster
accidentally removed bt min for all of the sst trials. so that's what I wanted to do anyway, so just keeping. 
```{r temp_AIC}

temp_AIC <- data.frame()

for (spp in spp_25$Spp_ID) {

  
  # match species ID to scientific name
  sci_name <- spp_list$sci_name_underscore[which (spp_list$Spp_ID == spp)]
  
  #grab presence/absence data for that species and attach to predictor data
  spp_PA <- mfri_pa %>%
    dplyr::select (sample_id, all_of(sci_name)) %>%
    left_join (mfri_pred, by = "sample_id") %>%
    slice_sample (n = 1000)
  
  
  # don't know how to do this elegantly within a pipe, but change colname to presence
  colnames(spp_PA)[2] <- "Presence"
  
  
  # non-zero biomass data; this will have variable size. 
  spp_B <- mfri_abun %>%
    filter (species == spp) %>%
    left_join (mfri_pred, by = "sample_id") %>%
    ungroup() %>% # don't know why but this fixes it
    slice_sample (prop = 0.3)
  
  # set gamma
  set.seed (10)
  gamma_PA <- log (nrow (spp_PA)) / 2
  gamma_B <- log (nrow (spp_B)) / 2
  
    
  # all temp vars
  gam_PA <- gam (Presence ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max) + s(bt_min),
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)
  
  gam_LB <- gam (kg_log ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max) + s(bt_min),
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
   # keep bt, drop bt min
  gam_PA_btm <- gam (Presence ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max),
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)
  
  gam_LB_btm <- gam (kg_log ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max),
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
  # # keep bt min, drop bt
  # gam_PA_bt <- gam (Presence ~  s(surface_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max),
  #                family = "binomial", 
  #                data = spp_PA,
  #                gamma = gamma_PA)
  # 
  # gam_LB_bt <- gam (kg_log ~  s(surface_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max),
  #                family = "gaussian", 
  #                data = spp_B,
  #                gamma = gamma_B)
  
  # drop sst_min
  
  gam_PA_smi <- gam (Presence ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(bt_max),
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)
  
  gam_LB_smi <- gam (kg_log ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(bt_max),
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
  # drop sst_max
  gam_PA_sma <- gam (Presence ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin)  + s(sst_min) + s(bt_max),
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)

  gam_LB_sma <- gam (kg_log ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin)  + s(sst_min) + s(bt_max),
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
                 
  # drop sst
  gam_PA_st <- gam (Presence ~  s(bottom_temp) + s(tow_depth_begin)  + s(sst_min) + s(bt_max),
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)

  gam_LB_st <- gam (kg_log ~   s(bottom_temp) + s(tow_depth_begin) +  s(sst_max) + s(sst_min) + s(bt_max),
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
  # record summary stats
  AIC_summary <- data.frame(
    Species = sci_name,
    PA = round(AIC(gam_PA), 2),
    LB = round(AIC(gam_LB), 2),
    PA_bt = round (AIC(gam_PA_bt) - AIC(gam_PA), 2),
    LB_bt = round (AIC (gam_LB_bt) - AIC(gam_LB), 2),
    PA_btm = round (AIC(gam_PA_btm) - AIC(gam_PA), 2),
    LB_btm = round (AIC (gam_LB_btm) - AIC(gam_LB), 2),
    PA_st = round (AIC(gam_PA_st) - AIC(gam_PA), 2),
    LB_st = round (AIC (gam_LB_st) - AIC(gam_LB), 2),
    PA_smi = round (AIC(gam_PA_smi) - AIC(gam_PA), 2),
    LB_smi = round (AIC (gam_LB_smi) - AIC(gam_LB), 2),
    PA_sma = round (AIC(gam_PA_sma) - AIC(gam_PA), 2),
    LB_sma = round (AIC (gam_LB_sma) - AIC(gam_LB), 2)
    
  )
  
  temp_AIC <- rbind (temp_AIC, AIC_summary)
  
}

write.csv (temp_AIC, file = "../Models/temperature_AIC_check.csv", row.names = FALSE)
    

```

### T

### Cod
```{r cod_data}
#subset cod presence and absence
cod_pa <- mfri_pa %>%
  dplyr::select (sample_id, Gadus_morhua) %>%
  rename (Presence = Gadus_morhua)

# append to sample info
cod_pred <- cod_pa %>%
  right_join (mfri_pred, by = "sample_id")  # use right_join to cut out faulty fall samples

# start with lat, lon, year, season, mfri temp, and salinity
```

```{r cod_limit_knots}
set.seed(10)
cod_gcv <- gam (Presence ~ te(lon, lat, k = -1) + year + season + s(surface_temp, k = -1) + s(bottom_temp, k = -1) + s(tow_depth_begin, k = -1),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_gcv)

gam.check(cod_gcv) # don't use for PA

```
"one or more supplied k too small - reset to default." This is identical to the model without doing k = -1. 
```{r limit_knots}

set.seed(10)
cod_k3 <- gam (Presence ~ te(lon, lat, k = 3) + year + season + s(surface_temp, k = 3) + s(bottom_temp, k = 3) + s(tow_depth_begin, k = 3),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_k3) # 66%



set.seed(10)
cod_k4 <- gam (Presence ~ te(lon, lat, k = 4) + year + season + s(surface_temp, k = 4) + s(bottom_temp, k = 4) + s(tow_depth_begin, k = 4),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_k4) # 68%

set.seed(10)
cod_unlim <- gam (Presence ~ te(lon, lat) + year + season + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin),
                 family = "binomial", 
                 data = cod_pred)


AIC (cod_k3, cod_k4, cod_unlim) # 6374, 6056. having more knots significantly better. 
```
AIC is substantially better with 4 knots instead of 3, and substantially better with unlimited knots. 

```{r cod_set_gamma}
# used in Morely et al. 2018 https://github.com/pinskylab/project_velocity/blob/master/6_model_fitting_loop.R; cites https://people.maths.bris.ac.uk/~sw15190/mgcv/tampere/mgcv-advanced.pdf

# penalize wiggliness by including EDF in GCV score

gamma_PA <- log (nrow (cod_pa)) / 2

set.seed(10)
cod_gamma <- gam (Presence ~ te(lon, lat) + year + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin),
                 family = "binomial", 
                 gamma = gamma_PA,
                 data = cod_pred)

summary (cod_gamma)


# test with biomass, so can look at gam.check
cod_B <- mfri_abun %>%
    filter (species == 1) %>%
    left_join (mfri_pred, by = "sample_id")

gamma_B <- log (nrow (cod_B)) / 2
  
  # fit gam
  cod_gam1_B <- gam (kg_log ~ te(lon, lat) + year + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin),
                 family = "gaussian", 
                 data = cod_B)
  
  cod_gamma1_B <- gam (kg_log ~ te(lon, lat) + year + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin),
                 family = "gaussian", 
                 gamma = gamma_B,
                 data = cod_B)
  
  AIC (cod_gam1_B, cod_gamma1_B) # 79825 vs 79871
  
  summary (cod_gam1_B) # 20.1 % exp (vs 20.6 with other terms). 7.4, 7.8, 8.8
  summary (cod_gamma1_B) # 19.8, 3.4, 6.3, 5.7
  
  gam.check (cod_gam1_B)
  gam.check (cod_gamma1_B) # neither looks great tbh
  
  plot (cod_gam1_B, residuals = TRUE, 
      select = 2, 
      #ylim = c (-5, 5), 
      ylab = "", xlab = "", 
      main = paste ("s(sst)", round (summary (cod_gam1_B)$edf[2], 2), sep = ", "))
    plot (cod_gamma1_B, residuals = TRUE, 
      select = 2, 
      #ylim = c (-5, 5), 
      ylab = "", xlab = "", 
      main = paste ("gamma s(sst)", round (summary (cod_gamma1_B)$edf[2], 2), sep = ", "))

```
This has everything below 5 (except tensor spline) and still good dev explained (19.8% with gamma vs. 20.1%). year isn't significant. AIC is lower for unlimited model by ~50. Should I test AUC, TSS?


```{r cod_full}

cod_full <- gam (Presence ~ te(lon, lat) + year + season + s(surface_temp) + s(bottom_temp) + s(gins_sal) +s(tow_depth_begin),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_full)

par (mfrow = c (2, 3), mar = c (2, 1.5, 1.5, 1.5), oma = c(0,1,2,0))
plot (cod_full, residuals = TRUE, 
      select = 1, 
      ylab = "", xlab = "", 
      main = paste ("te(Lon, Lat)", round (summary (cod_full)$edf[1], 2), sep = ", "))
plot (cod_full, residuals = TRUE, 
      select = 2, 
      #ylim = c (-5, 5), 
      ylab = "", xlab = "", 
      main = paste ("s(sst)", round (summary (cod_full)$edf[2], 2), sep = ", "))
plot (cod_full, residuals = TRUE, 
      select = 3, 
      #ylim = c (-10, 10), 
      ylab = "", xlab = "", 
      main = paste ("s(bt)", round (summary (cod_full)$edf[3], 2), sep = ", "))
plot (cod_full, residuals = TRUE, 
      select = 4, 
      #ylim = c (-10, 15), 
      ylab = "", xlab = "", 
      main = paste ("s(sal)", round (summary (cod_full)$edf[4], 2), sep = ", "))


```
One extreme low residual. not sure how to find it
```{r resid_hist}
resid <- residuals.gam(cod_full)
hist (resid)
```

```{r drop_var_table}
full.terms <- c ("te (lon, lat)", "year", "season", "s(surface_temp)", "s(bottom_temp)", "s(gins_sal)")

single.var.comp <- data.frame()
for (x in full.terms){
  # single variable model
  formula <- as.formula (paste0 ("Presence ~", x))
  G <- gam (formula, family = binomial, data = cod_pred)
  
  # full model without that variable
 formula_drop <- as.formula (paste0 ("Presence ~", (paste (full.terms[! full.terms %in% x], collapse = " + "))))
 G_drop <- gam (formula_drop, family = binomial, data = filter (cod_pred, !is.na (x)))
 

  # extract summaries, put together in temporary df
  df <- data.frame (Var = x, 
                    R2_full = round (summary (cod_full)$dev.expl * 100, 2),
                
                    R2_s = round (summary(G)$dev.expl * 100, digits = 2),
                   
                    R2_d =  round (summary(G_drop)$dev.expl * 100, digits = 2),
                    #N_full = length (G_full$y),
                    
                    Diff_full = round (summary(G_drop)$dev.expl * 100 - summary (cod_full)$dev.expl * 100, 2)
  )
  
  # rbind to full data frame
  single.var.comp <- rbind (single.var.comp, df)
  
}

dir.create ("../Models/PresAbs_summary_tables")
save (single.var.comp, file = "../Data/PA_model_tables/Cod_single_var_comp.RData")
```
Lat/lon has biggest signal -- 13%, driving 50% of the signal. . season is the next, 4. Salinity makes worse. 
```{r lat_lon_interaction}
# lat/lon interaction
cod_full_2 <- gam (Presence ~ s(lon,lat) + year + season + s(surface_temp) + s(bottom_temp) + s(gins_sal),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_full_2)
```

```{r sat_vs_insitu}
# satellite instead of in situ
cod_full_sat <- gam (Presence ~ te(lon, lat) + year + season + s(oisst) + s(gins_bt) + s(gins_sal) +s(tow_depth_begin),
                 family = "binomial", 
                 data = cod_pred)

summary (cod_full_sat)

```

### Seeing really weird behavior in prediction rasters, may be a result of tensor spline?
8/10/2020
Try cod model with just lat. I think this was an issue with my hammerhead models
```{r cod_lat_only}

# match species ID to scientific name
  sci_name <- "Gadus_morhua"
  spp <- 1
  
  #grab presence/absence data for that species and attach to predictor data
  spp_PA <- mfri_pa %>%
    dplyr::select (sample_id, all_of(sci_name)) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # don't know how to do this elegantly within a pipe, but change colname to presence
  colnames(spp_PA)[2] <- "Presence"
  
  
  # non-zero biomass data; this will have variable size. 
  spp_B <- mfri_abun %>%
    filter (species == spp) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # define gamma
  gamma_PA <- log (nrow (spp_PA)) / 2
  gamma_B <- log (nrow (spp_B)) / 2

  
set.seed(10)

 gam_PA <- gam (Presence ~ s(lat) + year + s(surface_temp) + s(bottom_temp) +s(tow_depth_begin),
                 family = "binomial", 
                 data = spp_PA,
                gamma = gamma_PA)
  
  gam_LB <- gam (kg_log ~ s(lat) + year + s(surface_temp) + s(bottom_temp) +s(tow_depth_begin),
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
  summary (gam_PA) # 67
  summary (gam_LB) # 14

```
seems like don't lose a lot of dev expl for PA (67 instead of 69ish), but yes for biomass (only 14% instead of 20ish). 

Run this through build prediction rasters and still have really weird behavior, really high values at higher latitudes:
![Sample lat only cod prediction (245, timestep 1)](../Figures/cod_245_latonly_predict.png)
try with smooth s(lat,lon) interaction 
```{r cod_smooth_latlon}
# have model code above, modifying so I can just run through build_prediction_rasters.R

#rename models so I can compare AIC
latonly_LB <- gam_LB
latonly_PA <- gam_PA

#copying code here 
# match species ID to scientific name
  sci_name <- "Gadus_morhua"
  spp <- 1
  
  #grab presence/absence data for that species and attach to predictor data
  spp_PA <- mfri_pa %>%
    dplyr::select (sample_id, all_of(sci_name)) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # don't know how to do this elegantly within a pipe, but change colname to presence
  colnames(spp_PA)[2] <- "Presence"
  
  
  # non-zero biomass data; this will have variable size. 
  spp_B <- mfri_abun %>%
    filter (species == spp) %>%
    left_join (mfri_pred, by = "sample_id")
  
  # define gamma
  gamma_PA <- log (nrow (spp_PA)) / 2
  gamma_B <- log (nrow (spp_B)) / 2

  
set.seed(10)

 gam_PA <- gam (Presence ~ s(lat, lon) + year + s(surface_temp) + s(bottom_temp) +s(tow_depth_begin),
                 family = "binomial", 
                 data = spp_PA,
                gamma = gamma_PA)
  
  gam_LB <- gam (kg_log ~ s(lat, lon) + year + s(surface_temp) + s(bottom_temp) +s(tow_depth_begin),
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
  summary (gam_PA) # 68
  summary (gam_LB) # 21
  
  AIC (gam_PA, latonly_PA) # s(lat,lon) is much better) 5055 vs 6238 [tensor is 5949]
  AIC (gam_LB, latonly_LB) # s(lat,lon is better: 79638 vs 81486) [ tensor is 79825]


```
s(lat,lon) seems like a good choice. Doesn't appear to be making any weird distortions, in fact looks similar to depth map. 

Going to move forward with s(lat, lon) and gamma. Redoing model fitting and predicitons starting 8/10. 

### incorporating habitat proxy variables

8/26/2020
```{r bormicon}

borm_gam_LB <- gam (kg_log ~ s(lat, lon) + year + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) + bormicon_region,
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
borm_gam_PA <- gam (Presence ~ s(lat, lon) + year + s(surface_temp) + s(bottom_temp) + s(tow_depth_begin)+ bormicon_region,
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)

summary (borm_gam_PA) # 68.9, n = 25469
summary (borm_gam_LB) # 21.8, n - 22404

AIC (borm_gam_PA, borm_gam_LB) # 5937, 79377. so better than s(lat, lon)

```
```{r drop lat/lon and year}
borm_only_gam_LB <- gam (kg_log ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin) + bormicon_region,
                 family = "gaussian", 
                 data = spp_B,
                 gamma = gamma_B)
  
borm_only_gam_PA <- gam (Presence ~  s(surface_temp) + s(bottom_temp) + s(tow_depth_begin)+ bormicon_region,
                 family = "binomial", 
                 data = spp_PA,
                 gamma = gamma_PA)

summary (borm_only_gam_PA) # 68.1, n = 25469
summary (borm_only_gam_LB) # 15.4, n - 22404

AIC (borm_only_gam_PA, borm_only_gam_LB) # 6056, 81081. worse than s(lat,lon)

```

