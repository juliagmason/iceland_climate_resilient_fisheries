---
title: "Explore MFRI survey data"
date: "2020-06-16"
output: html_notebook
---

Pamela Woods provided autumn and spring survey data on 6/16/20. Performing preliminary data exploration here. 

Info on the survey, from 2020 survey manual:
Covers the shelf to depths of 500m. 
Stratification and allocation of stations is divided into Northern and Southern regions. Allocation based on pre-estimated cod density patterns. 

Bottom trawl, 3.8knots for 4nm. several tows are shorter than 4nm? 2nm min. 

```{r setup}
library(tidyverse)
library (skimr)
library (lubridate)

comb_ds <- read_csv ("../Data/MFRI_comb_survey.csv",
                      col_types = cols(
                      sample_id = col_factor(),
                      species = col_factor(),
                      stat_sq = col_factor())
)

comb_samples <- read_csv("../Data/MFRI_comb_survey_samples.csv",
                          col_types = cols(
                      sample_id = col_factor(),
                      stat_sq = col_factor())
)
```

```{r skim}
skim (aut_ds)
skim (spr_ds)
```

Spring survey has 20297 samples (feb-apr), 1985-2020. 85 unique spp, top are cod(ID 1), haddock(2), redfish (5), long rough dab (28). Autumn has 8705, 1995-2019 (sep-nov), 82 spp, same top 5. 29002 total samples, 465 stat_sq, 1094 stations. 

Briefly panicked because comb_ds has 91 unique species but comb_samples has only 79. This is expected; just took distinct samples, not distinct samples and species. In my full PA set, have full 91 species. 

Discovered that sebasetes mentella (61, 11) is repeated. Majority of samples are 61; only 16 have 11. Will ask, but replace 11 with 61 for now. 


### Temporal extent
```{r tow_months}
comb_samples %>%
  group_by (month(date)) %>%
  summarize (count = n()) %>%
  rename (month = `month(date)`) %>%
  ggplot (aes (x = month, y = count)) +
  geom_bar(stat = 'identity') +
  geom_text (aes (label = count), vjust = 0.1)


unique (comb_ds$year[which(comb_ds$month ==4)])
unique (comb_ds$year[which(comb_ds$month ==)])
unique (comb_ds$year[which(comb_ds$month ==11)])

```
Only 33 samples in april, really negligible. Only in 1998 and 2005. 

```{r tow_years}
comb_samples %>%
  ggplot()+
  geom_bar(aes(x = year, fill = season), bins = 36) +
  ggtitle ("Tows per year")
```
doesn't look like any particular trend over time for spring. Autumn expanded sampling in 2001 and then fairly constant except for a very low year in 2011. 

#### Temporal extent of sampling stations
I basically want a presence/absence table, but with stations. There should be around 590 stations
```{r station_duration}

all_years <- data.frame (year = 1985:2020)

#start with stat_Sq
# separate fall and spring?
stat_sq_ts_spr <- comb_samples %>%
  filter (season == "spring") %>%
  distinct_at (c("stat_sq", "year")) %>%
  group_by (stat_sq) %>%
  summarize (count = n())

length (which (stat_sq_ts_spr$count == 36)) # 205
length (which (stat_sq_ts_spr$count > 30)) # 255
length (which (stat_sq_ts_spr$count < 5)) # 43 less than 5, 48 < 10

stat_sq_ts_aut <- comb_samples %>%
  filter (season == "autumn") %>%
  distinct_at (c("stat_sq", "year")) %>%
  group_by (stat_sq) %>%
  summarize (count = n())  # 340

length (stat_sq_ts_aut$stat_sq[which (stat_sq_ts_aut$stat_sq %in% stat_sq_ts_spr$stat_sq)]) # 211 shared

length (which (stat_sq_ts_aut$count == 25))
length (which (stat_sq_ts_aut$count > 24))

length (stat_sq_ts_aut$stat_sq[which (stat_sq_ts_aut$stat_sq %in% stat_sq_ts_spr$stat_sq & stat_sq_ts_aut$count > 20)]) # 161

#want a table with presence/absence of each stat sq, with years as columns?
station_ts_spr <- comb_samples %>%
  filter (season == "spring") %>%
  distinct_at (c("station", "year")) %>%
  group_by (station) %>%
  summarize (count = n())

hist (station_ts_spr$count)
length (which (station_ts_spr$count ==36)) # 436
length (which (station_ts_spr$count > 30)) # 518

station_ts_aut <- comb_samples %>%
  filter (season == "autumn") %>%
  distinct_at (c("station", "year")) %>%
  group_by (station) %>%
  summarize (count = n())

hist (station_ts_aut$count)

length (which (station_ts_aut$count >20)) # 280

length (which (station_ts_aut$station %in% station_ts_spr$station))

comb_samples %>%
  group_by(year, season) %>%
  summarise (n_stations = length (unique(station))) %>%
  ggplot (aes (x = year, y = n_stations, col = season)) +
  geom_point() +
  geom_line()

```
336 stat_sq in spring; 205 sampled every year, 255 sampled in 30+ years. 340 stat_sq in autumn, 211 shared with spring. Only 34 sampled all years. 230 > 20 years. 211>22, 150>23. 

680 stations in spring; 436 in all years, 518 > 30. 414 in autumn, 280 above 20. No overlap between spring and fall.

### Spatial extent
```{r tow_locations}

comb_samples %>%
  ggplot () +
  geom_boxplot(aes (x = season, y = lat))

comb_samples %>%
  ggplot () +
  geom_boxplot(aes (x = season, y = lon))

```
Lon looks the same, although autumn has a wider spread. Spring has a more northern median, autumn also wider spread. 
```{r tow_loc_time}
comb_samples %>%
  ggplot () +
  geom_violin(aes (x = factor(month(date)), y = lat))

comb_samples %>%
  ggplot () +
  geom_violin(aes (x = factor(month(date)), y = lon))
```

plot on map
```{r spr_map}
library (ggmap)

isl_basemap <- get_map (location = c(-30, 60, -5, 70), source = "stamen", maptype = "terrain", crop = FALSE)

ggmap(isl_basemap) +
  geom_point (aes (x = lon, y = lat), data = spr_samples) +
  ggtitle ("Spring survey locations")
```


```{r fall_map}

ggmap(isl_basemap) +
  geom_point (aes (x = lon, y = lat), data = aut_samples) +
  ggtitle ("Fall survey locations")

```

```{r tow_depth}
comb_samples %>% ggplot (aes (x = season, y = tow_depth_begin)) + geom_boxplot()
comb_samples %>% ggplot (aes (x = season, y = tow_depth_end)) + geom_boxplot()

comb_samples %>% ggplot (aes (x = tow_depth_begin, col = season)) + geom_density()

comb_samples %>% ggplot (aes (x = tow_depth_end, col = season)) + geom_density()
```
Autumn has deeper samples, but just a much fatter tail. still has mostly shallower samples. Spring also has a few deep ones. 

### Temperature data
```{r temp_hist}

ggplot (comb_samples) +
  geom_density (aes (x = surface_temp, col = season))

ggplot (comb_samples) +
  geom_boxplot (aes (x = season, y = surface_temp))

ggplot (comb_samples) +
  geom_density (aes (x = bottom_temp, col = season))

ggplot (comb_samples) +
  geom_boxplot (aes (x = season, y =bottom_temp))
```
SST: Warmer temps in the fall, peak around 9 degrees and another small peak at 6. Spring peak at 3 and 4-7. Autumn has more spread, some values go below spring it looks like. 

Bottom temp: fall is bimodal,peak just below zero and at 7. Spring peak around 3 and 5. fall still warmer, with more spread. 
```{r temp_ts}
ggplot (comb_samples) +
  geom_point (aes (x = date, y =bottom_temp))

temp_month_ts <- comb_samples %>%
  group_by(date) %>%
  summarise (
    count = n(),
    mn_sst = mean(surface_temp, na.rm = TRUE),
    se_sst = sd (surface_temp, na.rm = TRUE)/sqrt(count),
    mn_bt = mean (bottom_temp, na.rm = TRUE),
    se_bt = sd (bottom_temp, na.rm = TRUE)/sqrt(count)
  ) %>%
  mutate (season = ifelse (month(date) %in% c(2:4), "spring", "fall"))

sst_fall_fit <- lm (surface_temp ~ date, data = filter (comb_samples, season == "autumn"))
summary (sst_fall_fit) # y = 5.05 + 1.6e-04x, adj R2 = 0.035

sst_spr_fit <- lm (surface_temp ~ date, data = filter (comb_samples, season == "spring"))
summary (sst_spr_fit) # y = 3.27 + 9.67e-05x, adj R2 = 0.028

temp_month_ts %>%
  ggplot (aes (x = date, y = mn_sst, col = season)) +
  geom_point() +
  geom_line() +
  geom_smooth (method = "lm")

temp_month_ts %>%
  ggplot (aes (x = date, y = mn_bt, col = season)) +
  geom_point() +
  geom_line() +
  geom_smooth (method = "lm")
```
SST increasing in both seasons. BT too, much more variable. 
```{r sst_map}
library (viridis)
ggmap(isl_basemap) +
  geom_point (aes (x = lon, y = lat, col = surface_temp), data = comb_samples) +
  scale_color_viridis(option ="inferno") +
  ggtitle ("SST at all survey locations")
```

```{r temp_lat}
ggplot (comb_samples, aes (x = lat, y = surface_temp, col = season)) +
  geom_point(alpha= 0.5) +
  geom_smooth (method ="lm")

sst_fall_lat_fit <- lm (surface_temp ~ lat, data = filter (comb_samples, season == "autumn"))
summary (sst_fall_lat_fit) # y = 71 -.98x, adj R2 = 0.43

sst_spr_lat_fit <- lm (surface_temp ~ lat, data = filter (comb_samples, season == "spring"))
summary (sst_spr_lat_fit) # y = 81.55 -1.18x, adj R2 = 0.45
```

### Gear variables
```{r gear_boxplots}
comb_samples %>%
  pivot_longer (
    cols = starts_with("tow"),
    names_to = "tow_info",
    values_to = "value"
  ) %>%
ggplot () +
  geom_histogram(aes (x = value, fill = season)) +
  facet_wrap (~tow_info, scales = "free")
```
Tow depth begin and end are left-skewed but that makes sense. Tow direction is a bit all over but probably fine. Tow-length has some weird patterns, there seems to be a few standard lengths and then some scatter. Tow speed and time look okay? Potentially different protocols for autumn and spring? Different depths, and peaks for length and time. 
```{r gear_dotcharts}
dotchart(comb_samples$tow_time, 
         groups = factor(comb_samples$season), 
         pch = comb_samples$season,
         main = "Tow time")

dotchart(comb_samples$tow_length, 
         groups = factor(comb_samples$season), 
         pch = comb_samples$season,
         main = "Tow length")

dotchart(comb_samples$tow_depth_begin, 
         groups = factor(comb_samples$season), 
         pch = comb_samples$season,
         main = "Tow depth, start")
```
Autumn samples are much deeper. 

```{r gear_depth_rltps}
comb_samples %>%
  ggplot (aes (x = tow_depth_begin, y = tow_length, col = season)) +
  geom_point() +
  ggtitle("Tow length vs tow depth")

comb_samples %>%
  ggplot (aes (x = tow_depth_begin, y = tow_time, col = season)) +
  geom_point() +
  ggtitle ("tow time vs tow depth")
```
Tow times are fairly standard. The longest one is the deepest and the shortest ones are fairly shallow, but there are some long shallow tows too. 


### Species info

quick check about length biomass etc, might want to animate
```{r biomass_check}
# cod_kg_ts <- comb_samples %>%
#   filter (species == 1) %>%
#   group_by (season, year(date), length_cm) %>%
#   summarise (mn_kg = mean (kg_per_nautmile, na.rm = TRUE))
#   
# ggplot (cod_kg_ts,
#         aes (x = `year(date)`, y = mn_kg, col = as.factor(length_cm))) +
#   geom_point() + 
#   geom_line() +
#     facet_wrap (~season)

comb_samples %>%
  filter (species ==1) %>%
  ggplot (aes (x = date, y = kg_per_nautmile)) +
  geom_point()

comb_samples %>%
  filter (species ==1) %>%
  ggplot (aes (x = lat, y = kg_per_nautmile)) +
  geom_point

comb_samples %>%
  filter (species ==1) %>%
  ggplot (aes (x = lon, y = kg_per_nautmile)) +
  geom_point()

```

Which species can I cut out? any that have fewer than 10 in any month?
```{r spp_tally}
#tally samples 
spp_tally <- comb_ds %>%
  distinct_at (c("sample_id", "species"), .keep_all = TRUE) %>%
  group_by (species) %>%
  tally() %>%
  arrange(desc(n))# %>%
  #View()

hist (spp_tally$n, breaks = 30)

  
  spp_tally_yr <- comb_ds %>%
  distinct_at (c("sample_id", "species"), .keep_all = TRUE) %>%
  group_by (species, year) %>% 
    tally() 

  # filter 28 top spp
  major_spp <- filter (spp_list, Spp_ID %in% spp_tally_yr$species)
  
```
91 total species. 6 with only one entry: 73 (Ciliata mustela fivebearded rockling), 46 (Iceland cyprine), 91 (lycodes rossi, threespot eelpout), 77 (mussel), 95 (psetta maxima turbot), 42 (spider crab). Filtering for n>10 each year(wouldn't count no entries), get 76. n >100 each year, 60. n>500, 39. n>1000, 28.

11 spp have more than 10k samples.23 have more than 5000. 49 have more than 1000. 14 have fewer than 10, 

28 major spp: doesn't include monk or mackerel. 39 does have monkfish. 

Looking through abundance TS:
species with 2005-10 peak:
lemon sole, haddock, lumpfish(autumn)

downward trend:
starry skate

weird early 90s point, high blue whiting, arctic rockling

Look at PA full colsums
```{r PA_full_colsums}
mfri_pa <- read_csv ("../Data/PA_MFRI.csv",
                     col_types = cols(
                       sample_id = col_factor()
                     ))

# this has 90 spp

length (which (colSums (mfri_pa) > 5000)) # 24. 50 > 1000, 58 > 500

sample_yrs <- comb_samples %>%
  dplyr::select (sample_id, year, season)

spp_pa_yr <- mfri_pa %>%
  pivot_longer (-sample_id, 
                names_to = "species",
                values_to = "presence") %>%
  left_join (sample_yrs, by = "sample_id") %>%
  group_by (species, year, season) %>%
  summarize (n_p = sum(presence))

```

How many species have samples every year?
36 total years for spring, 25 total years for autumn. 
```{r sampled_all_yrs}
spp_yrs_sampled <- spp_pa_yr %>%
  mutate (p = ifelse (n_p > 0, 1, 0)) %>%
  group_by (species, season) %>%
  summarize (n_yrs_sampled = sum(p))

length(which (spp_yrs_sampled$season =="spring" & spp_yrs_sampled$n_yrs_sampled > 25)) 
length(which (spp_yrs_sampled$season =="autumn" & spp_yrs_sampled$n_yrs_sampled > 14)) 

# spring species consistently sampled
spring_spp <- unique(spp_yrs_sampled$species[which (spp_yrs_sampled$season =="spring" & spp_yrs_sampled$n_yrs_sampled ==36)]) 

# fall spp consistently sampled
fall_spp <- unique(spp_yrs_sampled$species[which (spp_yrs_sampled$season =="autumn" & spp_yrs_sampled$n_yrs_sampled > 24)])

#overlap in fall/spring consistent spp
fall_spp[which (fall_spp %in% spring_spp)]


```
27 spp sampled every spring, 29 every autumn. 25 in both. 37 have more than 30, 31 have more than 32 in spring. 

52 have < 10 years missing in spring, 63 in fall. 

#### Check anomalous points
1990, big spike in blue whiting. Sample 44366 has unusually high numbers, just of blue whiting it seems. 
```{r blue_whiting_1990}

comb_ds %>% 
  filter (species == 34 & year == 1990) %>%
  View()

comb_ds %>% 
  filter (sample_id == 44366) %>%
  group_by (species) %>%
  summarize (tot_kg = sum(kg_per_nautmile)) %>%
  ggplot (aes (y = tot_kg, x = species)) +
  geom_boxplot()
  View()

```
mid-90s rabbitfish 39. Looks like 73586 in 1996. no particular values jump out, just a high abundance of many size classes.
```{r rabbitfish}
comb_ds %>% 
  filter (species == 39 & between(year, 1995, 1998) & kg_per_nautmile > 1) %>%
  View()
```


#### Match landed and surveyed species
```{r landings_spp}
ldgs <- read_csv ("../Data/Landings_annual_all_sectors.csv")
spp_list <- read_csv("../Data/species_eng.csv")
match_spp <- read_csv("../Data/Match_spp_names.csv") %>% # this is only the 41 landed species. might be better to just add a column to spp_list?
  mutate (sci_name_underscore = gsub(" ", "_", Scientific_name)) # add underscore to match PA table

ld_spp <- sort (unique (ldgs$species))

ldgs %>%
  group_by (species) %>%
  summarize (tot_cat = sum(tonnes, na.rm = TRUE)) %>%
  arrange (desc (tot_cat))
```
41 landed species. Are any very rare in survey?
```{r landed_spp_n_yrs}
# just number of samples each year
spp_yrs_sampled %>%
  filter (species %in% match_spp$sci_name_underscore) %>%
  filter (n_yrs_sampled < 10) %>%
  View()

spp_yrs_sampled %>%
  filter (species %in% match_spp$sci_name_underscore) %>%
  #filter (n_yrs_sampled < 10) %>%
  View()
  
comb_ds %>%
  filter (species %in% match_spp$Spp_ID) %>%
  group_by (species, year) %>%
  summarize (tot_biomass = sum(kg_per_nautmile, na.rm = TRUE))

```
Grenadier C. rupestris only sampled in the autumn, but present in 24 years. Norway lobster, shrimp, and greenland shark don't have many samples. Mackerel also not well represented (14 autumn; 11 spring)

Are there commonly caught species that are NOT landed?
```{r not_landed}
spring_spp[which (!spring_spp %in% match_spp$sci_name_underscore)]
fall_spp[which (!fall_spp %in% match_spp$sci_name_underscore)]
```
Spring: A denticulatus (Arctic wolffish), lumpfish, Norway haddock [perhaps in with haddock or redfish?], Norway pout
Fall: Polar cod, lumpfish, gray gurnard, Norway haddock, Norway pout

# to get actual sample distributions for each species, would need to add the zeros back in for the samples with no catch. 
```{r test_distributions}
#https://aosmith.rbind.io/2019/03/06/lots-of-zeros/

# library(HMMpa)
# library (MASS)
# 
# cod_bm <- comb_ds %>%
#   filter (species == 1)

```
